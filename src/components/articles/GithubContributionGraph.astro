---
interface Props {
  username?: string;
  year?: number; // Anchor year (defaults to current year)
  months?: number; // Range: positive = from Jan, negative = from Dec (e.g., 6 = Jan-Jun, -6 = Jul-Dec)
}

const currentYear = new Date().getFullYear();
const { username = "wyndhamharyata", year: yearProp, months: monthsProp } = Astro.props;

// Parse props as numbers (handles string inputs from MDX)
const year = Number(yearProp) || currentYear;
const months = Number(monthsProp) || 12;

// Calculate date range based on year and months
let from: Date;
let to: Date;

// Clamp months to valid range
const clampedMonths = Math.max(-12, Math.min(12, months));

if (clampedMonths > 0) {
  // Positive: from start of year (e.g., 6 = Jan-Jun)
  from = new Date(year, 0, 1); // Jan 1
  // Use day 0 of next month to get last day of target month
  to = new Date(year, clampedMonths, 0);
} else if (clampedMonths < 0) {
  // Negative: from end of year (e.g., -6 = Jul-Dec)
  const startMonth = 12 + clampedMonths; // e.g., -6 â†’ month 6 (July, 0-indexed)
  from = new Date(year, startMonth, 1);
  to = new Date(year, 11, 31); // Dec 31
} else {
  // months = 0, show full year
  from = new Date(year, 0, 1);
  to = new Date(year, 11, 31);
}

const fromStr = from.toISOString().split("T")[0];
const toStr = to.toISOString().split("T")[0];

// Helper to filter table columns by date range
function filterTableByDateRange(html: string, fromDate: Date, toDate: Date): string {
  const fromMonth = fromDate.getMonth(); // 0-11
  const toMonth = toDate.getMonth(); // 0-11

  // Find all data-ix values that have dates in range
  const ixRegex = /data-ix="(\d+)"[^>]*data-date="(\d{4}-\d{2}-\d{2})"/g;
  const validIx = new Set<string>();
  let match;
  while ((match = ixRegex.exec(html)) !== null) {
    const ix = match[1];
    const dateStr = match[2];
    const date = new Date(dateStr);
    if (date >= fromDate && date <= toDate) {
      validIx.add(ix);
    }
  }

  // If no filtering needed (full year), return as-is
  if (fromMonth === 0 && toMonth === 11) {
    return html;
  }

  let filtered = html;

  // Filter month labels outside range
  const monthNames = [
    "January",
    "February",
    "March",
    "April",
    "May",
    "June",
    "July",
    "August",
    "September",
    "October",
    "November",
    "December",
  ];
  const shortMonths = [
    "Jan",
    "Feb",
    "Mar",
    "Apr",
    "May",
    "Jun",
    "Jul",
    "Aug",
    "Sep",
    "Oct",
    "Nov",
    "Dec",
  ];

  monthNames.forEach((month, idx) => {
    if (idx < fromMonth || idx > toMonth) {
      // Remove the entire month label cell containing this month
      // Match: <td class="ContributionCalendar-label" colspan="N" ...>...<span>Month</span>...</td>
      const monthRegex = new RegExp(
        `<td[^>]*class="[^"]*ContributionCalendar-label[^"]*"[^>]*>[\\s\\S]*?<span[^>]*>${month}</span>[\\s\\S]*?</td>`,
        "g"
      );
      filtered = filtered.replace(monthRegex, "");
    }
  });

  // Filter day cells outside range (by data-ix)
  // Match cells with data-ix and their following tool-tip
  filtered = filtered.replace(
    /<td[^>]*data-ix="(\d+)"[^>]*>[^<]*<\/td>\s*(?:<tool-tip[^>]*>[\s\S]*?<\/tool-tip>)?/g,
    (match, ix) => {
      if (ix && !validIx.has(ix)) {
        return "";
      }
      return match;
    }
  );

  // Remove day label cells (Mon, Wed, Fri) from tbody rows
  filtered = filtered.replace(
    /<td[^>]*class="[^"]*ContributionCalendar-label[^"]*"[^>]*>[\s\S]*?<\/td>/g,
    (match) => {
      // Keep header row labels (months), remove tbody labels (days)
      if (
        match.includes("Sun") ||
        match.includes("Mon") ||
        match.includes("Tue") ||
        match.includes("Wed") ||
        match.includes("Thu") ||
        match.includes("Fri") ||
        match.includes("Sat")
      ) {
        return "";
      }
      return match;
    }
  );

  // Also remove the "Day of Week" header cell
  filtered = filtered.replace(
    /<td[^>]*>\s*<span class="sr-only">Day of Week<\/span>\s*<\/td>/g,
    ""
  );

  return filtered;
}

// Fetch contribution data server-side
let tableHtml = "";
let error = "";

try {
  const response = await fetch(`https://github.com/users/${username}/contributions`);
  const html = await response.text();

  // Extract the table element from the response
  const tableMatch = html.match(
    /<table[^>]*class="[^"]*ContributionCalendar-grid[^"]*"[^>]*>[\s\S]*?<\/table>/
  );

  if (tableMatch) {
    // Filter the table to only show dates in range
    tableHtml = filterTableByDateRange(tableMatch[0], from, to);
  } else {
    error = "Could not parse contribution data";
  }
} catch (e) {
  error = "Failed to fetch contribution data";
}
---

<div class="contribution-graph not-prose mx-auto -my-6 w-full max-w-[720px]">
  {
    error ? (
      <p class="text-base-content/50 text-sm italic">{error}</p>
    ) : (
      <Fragment set:html={tableHtml} />
    )
  }
</div>

<style>
  .contribution-graph {
    width: 100%;
    overflow-x: auto;
    --empty-cell-bg: var(--color-base-300);
  }

  :global(.dark) .contribution-graph {
    --empty-cell-bg: oklch(32% 0.015 250);
  }

  /* Override GitHub's height-full class that stretches the container */
  .contribution-graph :global(.height-full) {
    height: auto !important;
  }

  /* Make table fill container width */
  .contribution-graph :global(table) {
    width: 100%;
    border-collapse: separate;
    border-spacing: 4px;
    height: auto !important;
    table-layout: fixed;
  }

  /* Let rows size naturally based on cell content */
  .contribution-graph :global(tbody tr) {
    height: auto;
  }

  .contribution-graph :global(thead tr) {
    height: auto;
  }

  /* Square cells using padding trick */
  .contribution-graph :global(.ContributionCalendar-day) {
    padding: 0;
    border-radius: 2px;
    box-sizing: border-box;
    position: relative;
  }

  .contribution-graph :global(.ContributionCalendar-day)::before {
    content: "";
    display: block;
    padding-bottom: 100%; /* Creates square aspect ratio */
  }

  /* Contribution levels using theme primary color with opacity */
  .contribution-graph :global([data-level="0"]) {
    background-color: var(--empty-cell-bg);
  }
  .contribution-graph :global([data-level="1"]) {
    background-color: oklch(from var(--color-primary) l c h / 0.3);
  }
  .contribution-graph :global([data-level="2"]) {
    background-color: oklch(from var(--color-primary) l c h / 0.5);
  }
  .contribution-graph :global([data-level="3"]) {
    background-color: oklch(from var(--color-primary) l c h / 0.75);
  }
  .contribution-graph :global([data-level="4"]) {
    background-color: var(--color-primary);
  }

  /* Style month labels */
  .contribution-graph :global(.ContributionCalendar-label) {
    color: var(--color-base-content);
    opacity: 0.6;
    font-size: 0.65rem;
  }

  /* Hide GitHub's tooltips (they use JS and won't work) */
  .contribution-graph :global(tool-tip) {
    display: none;
  }

  /* Hide screen reader only content */
  .contribution-graph :global(.sr-only) {
    display: none;
  }
</style>
