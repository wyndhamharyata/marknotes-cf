---
import { filterTableByDateRange } from "./contribution-filter";
import "./GithubContributionGraph.css";

interface Props {
  username?: string;
  year?: number;
  months?: number;
}

const currentYear = new Date().getFullYear();
const { username = "wyndhamharyata", year: yearProp, months: monthsProp } = Astro.props;

const year = Number(yearProp) || currentYear;
const months = Math.max(-12, Math.min(12, Number(monthsProp) || 12));

const dateRanges: Record<number, { from: Date; to: Date }> = {
  1: { from: new Date(year, 0, 1), to: new Date(year, months, 0) },
  [-1]: { from: new Date(year, 12 + months, 1), to: new Date(year, 11, 31) },
  0: { from: new Date(year, 0, 1), to: new Date(year, 11, 31) },
};

const { from, to } = dateRanges[Math.sign(months)];

let tableHtml = "";
let error = "";

try {
  const response = await fetch(`https://github.com/users/${username}/contributions`);
  const html = await response.text();

  const tableMatch = html.match(
    /<table[^>]*class="[^"]*ContributionCalendar-grid[^"]*"[^>]*>[\s\S]*?<\/table>/
  );

  if (tableMatch) {
    tableHtml = filterTableByDateRange(tableMatch[0], from, to);
  } else {
    error = "Could not parse contribution data";
  }
} catch (e) {
  error = "Failed to fetch contribution data";
}
---

<div class="contribution-graph not-prose mx-auto -my-6 w-full max-w-[720px]">
  {
    error ? (
      <p class="text-base-content/50 text-sm italic">{error}</p>
    ) : (
      <Fragment set:html={tableHtml} />
    )
  }
</div>
