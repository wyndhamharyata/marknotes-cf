---
import { getCommentsBySlug, buildCommentTree } from "../../lib/comments/repository";
import { getOrCreateAlias } from "../../lib/comments/diceware";
import CommentTree from "./CommentTree";

interface Props {
  articleSlug: string;
}

const { articleSlug } = Astro.props;

let alias = "anonymous";
let serializedTree: any[] = [];
let error: string | null = null;

try {
  // Get or create the user's alias (sets cookie if new)
  alias = getOrCreateAlias(Astro.cookies);

  // Fetch comments from database
  const comments = await getCommentsBySlug(articleSlug);
  const commentTree = buildCommentTree(comments);

  // Serialize dates to ISO strings for Preact
  serializedTree = JSON.parse(JSON.stringify(commentTree));
} catch (e) {
  error = e instanceof Error ? e.message : String(e);
  console.error("CommentSection error:", error);
}
---

<section class="card bg-base-100 mt-8 shadow-xl" data-comment-alias={alias}>
  <div class="card-body">
    <h2 class="card-title mb-4 text-2xl">Comments</h2>
    {
      error ? (
        <div class="alert alert-error">
          <span>Failed to load comments: {error}</span>
        </div>
      ) : (
        <CommentTree
          client:load
          comments={serializedTree}
          articleSlug={articleSlug}
          userAlias={alias}
        />
      )
    }
  </div>
</section>

<script>
  // Emit custom event when comment section loads with the alias
  document.addEventListener("DOMContentLoaded", () => {
    const section = document.querySelector("[data-comment-alias]");
    if (section) {
      const alias = section.getAttribute("data-comment-alias");
      if (alias) {
        window.dispatchEvent(new CustomEvent("comment-alias-loaded", { detail: { alias } }));
      }
    }
  });
</script>
