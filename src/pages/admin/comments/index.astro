---
export const prerender = false;

import { getCollection } from "astro:content";
import BaseAdminLayout from "../../../layouts/BaseAdminLayout.astro";
import { SITE_DESCRIPTION, SITE_TITLE, ADMIN_DOCK } from "../../../consts";
import { getCommentsForAdmin, getCommentCounts } from "../../../lib/comments/admin-repository";
import { type ModerationStatusType } from "../../../lib/comments/types";
import CommentFilter from "../../../components/admin/CommentFilter.astro";
import CommentModerationItem from "../../../components/admin/CommentModerationItem/CommentModerationItem.astro";
import Pagination from "../../../components/admin/Pagination.astro";

const url = new URL(Astro.request.url);
const statusParam = url.searchParams.get("status");
const pageParam = url.searchParams.get("page");

let filterStatus: ModerationStatusType | null = null;
if (statusParam !== null) {
  const statusNum = parseInt(statusParam, 10);
  if ([0, 1, 2, 3].includes(statusNum)) {
    filterStatus = statusNum as ModerationStatusType;
  }
}

const currentPage = Math.max(1, parseInt(pageParam ?? "1", 10) || 1);
const limit = 10;

const [{ comments, total }, counts] = await Promise.all([
  getCommentsForAdmin({ status: filterStatus, page: currentPage, limit }),
  getCommentCounts(),
]);

const totalPages = Math.ceil(total / limit);
const baseUrl =
  filterStatus !== null ? `/admin/comments?status=${filterStatus}` : "/admin/comments";

const articles = await getCollection("blog");
const articleTitleMap = new Map(articles.map((a) => [a.id, a.data.title]));

const enrichedComments = comments.map((c) => ({
  ...c,
  articleTitle: articleTitleMap.get(c.articleSlug) || c.articleSlug,
}));
---

<BaseAdminLayout
  title={SITE_TITLE}
  description={SITE_DESCRIPTION}
  dockProp={{ menus: ADMIN_DOCK, currentPath: "/admin/comments" }}
>
  <div class="flex w-3xl flex-col space-y-6">
    <h1 class="text-2xl font-bold">Comment Moderation</h1>

    <CommentFilter filterStatus={filterStatus} counts={counts} />

    {
      totalPages > 1 && (
        <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={baseUrl} />
      )
    }

    <div id="comment-list" class="w-3xl space-y-4">
      {
        enrichedComments.length === 0 && (
          <div class="card bg-base-100/60 p-8 text-center">
            <p class="text-base-content/60">No comments found</p>
          </div>
        )
      }

      {enrichedComments.map((comment) => <CommentModerationItem comment={comment} />)}
    </div>
  </div>
</BaseAdminLayout>
